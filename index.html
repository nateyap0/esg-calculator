<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESG Solver</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d1117;--panel:#161b22;--border:#30363d;--accent:#1f6feb;--text:#e6edf3;--text-dim:#c9d1d9;--red:#e74c3c;--card-bg:#f0f0f0;--card-border:#999}
body{font-family:-apple-system,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;justify-content:center;padding:20px}
#app{max-width:820px;width:100%}
h1{font-size:1.5rem;margin-bottom:16px;font-weight:700}
.srow{display:flex;gap:16px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.sg{display:flex;align-items:center;gap:6px}
.sg label{font-size:.82rem;color:var(--text-dim);white-space:nowrap;min-width:54px}
.hint{font-size:.72rem;color:#484f58;white-space:nowrap;margin-left:6px}
.bg{display:flex;gap:2px}
.bg button{padding:4px 10px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer;font-size:.82rem;border-radius:4px;font-family:inherit}
.bg button.act{background:var(--accent);border-color:var(--accent);color:#fff}
.bg button:hover:not(.act){background:#21262d}
.hdinfo{font-size:.78rem;color:var(--text-dim);margin-bottom:10px}
.trows{margin-bottom:12px}
.trow{display:flex;align-items:center;gap:10px;margin-bottom:8px;padding:10px 12px;background:var(--panel);border-radius:8px;border-left:3px solid transparent;cursor:pointer;transition:all .12s}
.trow:hover{background:#1c2333}
.trow.active{background:#1c2333}
.tl{font-weight:700;min-width:68px;font-size:.88rem;flex-shrink:0}
.card-slots{display:flex;gap:4px;flex-wrap:wrap;align-items:center;flex:1}
.card-slot{
  width:44px;height:60px;border:2px dashed var(--border);border-radius:6px;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  transition:all .15s;background:transparent;
}
.card-slot.filled{background:var(--card-bg);border:2px solid var(--card-border);cursor:pointer}
.card-slot.filled:hover{border-color:var(--red);opacity:.8}
.card-slot.filled .card-rank{font-size:1.15em;font-weight:700;font-family:'Courier New',monospace;line-height:1}
.card-slot.filled .card-suit{font-size:1.05em;line-height:1}
.card-slot.filled.suit-red{color:var(--red)}
.card-slot.filled.suit-black{color:#1a1a2e}
.board-divider{width:2px;height:40px;background:var(--accent);border-radius:2px;margin:0 3px;align-self:center;opacity:.4}
.tcnt{color:var(--text-dim);font-size:.78rem;white-space:nowrap}
.xbtn{padding:4px 9px;background:none;border:1px solid var(--border);color:var(--text-dim);border-radius:4px;cursor:pointer;font-size:.95rem;font-family:inherit;line-height:1;align-self:center;margin-left:6px}
.xbtn:hover{background:#da363333;border-color:#f85149;color:#f85149}
.rndbtn{padding:4px 9px;background:none;border:1px solid var(--border);color:var(--text-dim);border-radius:4px;cursor:pointer;font-size:.78rem;font-family:inherit;line-height:1;align-self:center;margin-left:2px}
.rndbtn:hover{background:#1f6feb33;border-color:var(--accent);color:var(--accent)}
.picker-grid{display:grid;grid-template-columns:repeat(13,1fr);gap:3px;margin-bottom:14px}
.picker-card{
  aspect-ratio:0.72;border-radius:5px;display:flex;align-items:center;justify-content:center;
  flex-direction:column;cursor:pointer;transition:all .12s;font-family:'Courier New',monospace;
  background:var(--card-bg);border:2px solid transparent;font-size:.88em;line-height:1.15;
}
.picker-card:hover:not(.s0):not(.s1):not(.s2):not(.s3):not(.s4):not(.s5):not(.s6){border-color:var(--accent);transform:scale(1.08);z-index:1}
.picker-card .p-rank{font-weight:700;font-size:1.2em}
.picker-card .p-suit{font-size:1.15em}
.picker-card.suit-red{color:var(--red)}
.picker-card.suit-black{color:#1a1a2e}
.picker-card.s0,.picker-card.s1,.picker-card.s2,.picker-card.s3,.picker-card.s4,.picker-card.s5,.picker-card.s6{opacity:.35;cursor:default}
.picker-card.s0{background:#58a6ff30;border-color:#58a6ff}
.picker-card.s1{background:#f9758330;border-color:#f97583}
.picker-card.s2{background:#56d36430;border-color:#56d364}
.picker-card.s3{background:#d2a8ff30;border-color:#d2a8ff}
.picker-card.s4{background:#f0883e30;border-color:#f0883e}
.picker-card.s5{background:#e3b34130;border-color:#e3b341}
.picker-card.s6{background:#79c0ff30;border-color:#79c0ff}
.ctrls{display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.rbtn{padding:9px 22px;border:1px solid #2ea043;background:#238636;color:#fff;font-size:.95rem;font-weight:600;border-radius:6px;cursor:pointer;font-family:inherit}
.rbtn:hover{background:#2ea043}.rbtn:disabled{opacity:.4;cursor:not-allowed}
.cbtn{padding:9px 16px;border:1px solid var(--border);background:#21262d;color:var(--text);font-size:.88rem;border-radius:6px;cursor:pointer;font-family:inherit}
.cbtn:hover{background:var(--border)}
.prog{flex:1;min-width:160px}
.ptxt{font-size:.78rem;color:var(--text-dim)}
.err{color:#f97583;font-size:.82rem;margin-bottom:10px;min-height:1.2em}
table{width:100%;border-collapse:collapse;font-size:.95rem}
th{text-align:center;padding:9px 10px;border-bottom:2px solid var(--border);color:var(--text-dim);font-weight:600}
td{text-align:center;padding:9px 10px;border-bottom:1px solid #21262d}
td:first-child{text-align:left;font-weight:700}
tr:last-child td{border-bottom:none}
#resultsArea{display:none}
#progressArea{display:none}
.info{font-size:.78rem;color:#484f58;margin-bottom:14px}
.title-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.title-row h1{margin-bottom:0}
.auth-bar{display:flex;align-items:center;gap:8px}
.auth-bar .user-info{display:flex;align-items:center;gap:8px;font-size:.8rem;color:#8b949e}
.auth-bar .user-info img{width:24px;height:24px;border-radius:50%}
.auth-bar .sign-out{color:#58a6ff;cursor:pointer;font-size:.75rem;text-decoration:underline;background:none;border:none;padding:0}
.auth-bar .sign-out:hover{color:#79c0ff}
.auth-links{display:flex;gap:8px}
.manage-link{font-size:.75rem;color:#58a6ff;cursor:pointer;text-decoration:underline;background:none;border:none;padding:0}
.manage-link:hover{color:#79c0ff}
.subscribe-prompt{text-align:center;padding:32px 20px;color:var(--text-dim);display:none;background:var(--panel);border:1px solid var(--border);border-radius:8px;margin:16px 0}
.subscribe-prompt h3{font-size:1.15rem;color:var(--text);margin-bottom:12px}
.subscribe-prompt .price-tag{font-size:1.5rem;font-weight:700;color:var(--text);margin-bottom:6px}
.subscribe-prompt .price-tag span{font-size:.85rem;font-weight:400;color:#8b949e}
.subscribe-prompt .sub-details{font-size:.8rem;color:#8b949e;margin-bottom:16px}
.subscribe-prompt ul{text-align:left;display:block;list-style:none;margin:0 auto 18px;padding:0;font-size:.85rem;width:fit-content}
.subscribe-prompt ul li{padding:4px 0;color:var(--text-dim)}
.subscribe-prompt ul li::before{content:'\2713 ';color:#3fb950;font-weight:700;margin-right:6px}
.btn-subscribe{display:block;margin:16px auto 0;background:#635bff;color:#fff;padding:10px 24px;border:none;border-radius:6px;cursor:pointer;font-size:.95rem;font-weight:600;transition:background .15s}
.btn-subscribe:hover{background:#7a73ff}
.auth-notice{text-align:center;padding:12px 16px;background:#1c2333;border:1px solid var(--border);border-radius:6px;margin-bottom:14px;font-size:.85rem;color:var(--text-dim)}
.auth-notice a{color:#58a6ff;cursor:pointer;text-decoration:underline}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid #fff3;border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:600px){
  body{padding:6px}
  .card-slot{width:38px;height:52px}
  .picker-grid{gap:2px}
  .picker-card{font-size:.6em}
  .tl{min-width:55px;font-size:.78em}
  .auth-bar .user-info{flex-direction:column;align-items:flex-end;gap:2px}
  .auth-bar .user-info .auth-links{display:flex;gap:8px}
  .bg-wrap7 button,.bg-wrap8 button{width:32px;padding:4px 0;text-align:center}
  .bg-wrap7{flex-wrap:wrap;max-width:calc(7 * 32px + 6 * 2px)}
  .bg-wrap8{flex-wrap:wrap;max-width:calc(8 * 32px + 7 * 2px)}
}
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<div id="app">
<div class="title-row">
<h1>ESG Solver</h1>
<div class="auth-bar" id="auth-bar">
  <div id="auth-signed-out"><div id="g_id_onload" data-client_id="411313261288-voso2pnj4v97bk80klmacq15tvqj5hqv.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div><div class="g_id_signin" data-type="standard" data-size="medium" data-theme="filled_black" data-text="signin_with" data-shape="rectangular"></div></div>
  <div id="auth-signed-in" style="display:none" class="user-info"><img id="auth-pic" src="" alt=""><span id="auth-name"></span><div class="auth-links"><button id="manage-sub-btn" class="manage-link" onclick="manageSubscription()" style="display:none">Manage Subscription</button><button class="sign-out" onclick="signOut()">Sign out</button></div></div>
</div>
</div>
<div class="srow">
  <div class="sg"><label>Trials</label><div class="bg" id="bTrials">
    <button data-v="10000">10K</button><button data-v="50000" class="act">50K</button>
    <button data-v="100000">100K</button>
  </div><span class="hint">takes a few seconds</span></div>
</div>
<div class="srow">
  <div class="sg"><label>Players</label><div class="bg" id="bPlayers">
    <button data-v="2" class="act">2</button><button data-v="3">3</button><button data-v="4">4</button><button data-v="5">5</button>
  </div></div>
</div>
<div class="srow">
  <div class="sg"><label>Starting</label><div class="bg bg-wrap7" id="bCards">
    <button data-v="1">1</button><button data-v="2">2</button><button data-v="3">3</button><button data-v="4">4</button><button data-v="5">5</button><button data-v="6" class="act">6</button><button data-v="7">7</button><button data-v="8">8</button><button data-v="9">9</button><button data-v="10">10</button><button data-v="11">11</button><button data-v="12">12</button><button data-v="13">13</button><button data-v="14">14</button>
  </div></div>
</div>
<div class="srow">
  <div class="sg"><label>Draws</label><div class="bg bg-wrap8" id="bDraws">
    <button data-v="0">0</button><button data-v="1">1</button><button data-v="2">2</button><button data-v="3">3</button><button data-v="4">4</button><button data-v="5">5</button><button data-v="6">6</button><button data-v="7">7</button><button data-v="8">8</button><button data-v="9" class="act">9</button><button data-v="10">10</button><button data-v="11">11</button><button data-v="12">12</button><button data-v="13">13</button><button data-v="14">14</button><button data-v="15">15</button>
  </div></div>
</div>
<div class="err" id="err"></div>
<div class="trows" id="trows"></div>
<div class="picker-grid" id="cgrid"></div>
<div class="hdinfo" id="hdinfo"></div>
<div class="info">PLO rules: must use exactly 2 from hand + 3 from board. Hand point: best 5-card hand from hole cards only.</div>
<div id="authNotice" class="auth-notice"></div>
<div class="ctrls">
  <button id="runBtn" class="rbtn" disabled>Run</button>
  <button id="rndAllBtn" class="cbtn">Random All</button>
  <button id="clrBtn" class="cbtn">Clear All</button>
  <div class="prog" id="progressArea"><div class="ptxt" id="ptxt"></div></div>
</div>

<div id="subscribePrompt" class="subscribe-prompt">
  <ul>
    <li>Monte Carlo equity simulation (up to 100K trials)</li>
    <li>2-5 players, 1-14 starting cards, 0-15 draws</li>
    <li>Board card input for both boards</li>
    <li>Board 1, Board 2, Hand, Scoop &amp; Equity breakdown</li>
  </ul>
  <button class="btn-subscribe" id="subscribeBtn" onclick="subscribe()">Subscribe &mdash; SGD$39/mo</button>
</div>

<div id="resultsArea">
  <table><thead><tr><th></th><th>Board 1</th><th>Board 2</th><th>Hand</th><th>Scoop</th><th>Equity</th></tr></thead>
  <tbody id="rbody"></tbody></table>
</div>
</div>
<script>
// ===== AUTH + SUBSCRIPTION =====
let idToken = localStorage.getItem('esg_id_token');
let authUser = JSON.parse(localStorage.getItem('esg_auth_user') || 'null');
let isSubscribed = localStorage.getItem('esg_subscribed') === 'true';

function handleCredentialResponse(response) {
  idToken = response.credential;
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  authUser = { name: payload.name, picture: payload.picture, email: payload.email };
  localStorage.setItem('esg_id_token', idToken);
  localStorage.setItem('esg_auth_user', JSON.stringify(authUser));
  updateAuthUI();
  checkSubscriptionStatus();
}

async function checkSubscriptionStatus() {
  if (!idToken) return;
  try {
    const resp = await fetch('/api/check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + idToken }
    });
    if (resp.status === 200) {
      isSubscribed = true;
      localStorage.setItem('esg_subscribed', 'true');
    } else if (resp.status === 403) {
      isSubscribed = false;
      localStorage.removeItem('esg_subscribed');
    }
  } catch {}
  updateAuthUI();
}

function signOut() {
  idToken = null;
  authUser = null;
  localStorage.removeItem('esg_id_token');
  localStorage.removeItem('esg_auth_user');
  google.accounts.id.disableAutoSelect();
  updateAuthUI();
}

function updateAuthUI() {
  const signedIn = !!idToken;
  document.getElementById('auth-signed-out').style.display = signedIn ? 'none' : '';
  document.getElementById('auth-signed-in').style.display = signedIn ? 'flex' : 'none';
  if (signedIn && authUser) {
    document.getElementById('auth-name').textContent = authUser.name;
    document.getElementById('auth-pic').src = authUser.picture || '';
  }
  document.getElementById('manage-sub-btn').style.display = (signedIn && isSubscribed) ? '' : 'none';
  updateNotice();
}

function updateNotice(){
  const el=document.getElementById('authNotice');
  const btn=document.getElementById('runBtn');
  if(!idToken){
    el.style.display='block';
    el.innerHTML='Sign in with Google to use the calculator.';
    if(!running) btn.textContent='Sign in to Run';
  }else if(!isSubscribed){
    el.style.display='block';
    el.innerHTML='Subscription required to run simulations.';
    if(!running) btn.textContent='Run';
    document.getElementById('subscribePrompt').style.display='block';
  }else{
    el.style.display='none';
    document.getElementById('subscribePrompt').style.display='none';
    if(!running) btn.textContent='Run';
  }
}

function isTokenExpired() {
  if (!idToken) return true;
  try {
    const payload = JSON.parse(atob(idToken.split('.')[1]));
    return payload.exp * 1000 < Date.now();
  } catch { return true; }
}

function ensureValidToken() {
  if (!idToken) return false;
  if (isTokenExpired()) {
    idToken = null;
    localStorage.removeItem('esg_id_token');
    updateAuthUI();
    google.accounts.id.prompt();
    return false;
  }
  return true;
}

function subscribe() {
  const email = authUser ? authUser.email : '';
  let url = 'https://buy.stripe.com/7sY7sM4ygd718fRa650Ba01';
  if (email) url += '?prefilled_email=' + encodeURIComponent(email);
  window.location.href = url;
}

function manageSubscription() {
  window.open('https://billing.stripe.com/p/login/8x214o7Ks9UPanZced0Ba00', '_blank');
}

function checkPaidReturn() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('paid')) {
    window.history.replaceState({}, '', window.location.pathname);
    isSubscribed = true;
    localStorage.setItem('esg_subscribed', 'true');
    updateAuthUI();
  }
}

// ===== CARD UI =====
const RANK_IDX=[12,0,1,2,3,4,5,6,7,8,9,10,11];
const RCHAR='23456789TJQKA';
const SUIT='\u2660\u2665\u2666\u2663';
const SCLS=[1,0,0,1];
// Colors: P1 blue, P2 red, P3 green, P4 purple, P5 orange, B1 gold, B2 cyan
const TCOL=['#58a6ff','#f97583','#56d364','#d2a8ff','#f0883e','#e3b341','#79c0ff'];
const TNAME=['Player 1','Player 2','Player 3','Player 4','Player 5','Board 1','Board 2'];

let nP=2,nC=6,nD=9,nT=50000;
let aT=0; // active target: 0-4 players, 5-6 boards
let pCards=[[],[],[],[],[]]; // player hands
let bCards=[[],[]]; // board cards (up to 5 each)
let assign=new Int8Array(52).fill(-1); // card -> target (-1=free, 0-4=player, 5-6=board)
let running=false;

function cardName(c){return RCHAR[c>>2]+SUIT[c&3]}
function suitCls(c){return SCLS[c&3]?'sb':'sr'}

function initBg(id,cb){
  document.getElementById(id).querySelectorAll('button').forEach(b=>{
    b.addEventListener('click',()=>{
      b.parentElement.querySelectorAll('button').forEach(x=>x.classList.remove('act'));
      b.classList.add('act');
      cb(+b.dataset.v);
    });
  });
}
initBg('bPlayers',v=>{nP=v;onCfg()});
initBg('bCards',v=>{nC=v;onCfg()});
initBg('bDraws',v=>{nD=v;render()});
initBg('bTrials',v=>{nT=v});

function tableSize(){return Math.max(nP,Math.min(7,Math.floor(42/nC)))}

function actualDraws(){
  const muck=(tableSize()-nP)*nC;
  return Math.min(nD,Math.floor(muck/nP));
}
function finalHandSize(){
  return nC+actualDraws();
}

function maxCards(t){return t<5?nC:5}

function getCards(t){return t<5?pCards[t]:bCards[t-5]}

function setCards(t,arr){if(t<5)pCards[t]=arr;else bCards[t-5]=arr;}

function onCfg(){
  // trim player hands if starting cards reduced
  for(let p=0;p<5;p++){
    if(p>=nP){pCards[p].forEach(c=>assign[c]=-1);pCards[p]=[];}
    else while(pCards[p].length>nC){assign[pCards[p].pop()]=-1;}
  }
  if(aT<5&&aT>=nP)aT=0;
  validate();render();
}

function validate(){
  const el=document.getElementById('err');
  el.textContent='';
  let ok=true;
  for(let p=0;p<nP;p++)if(pCards[p].length!==nC)ok=false;
  document.getElementById('runBtn').disabled=!ok||running;
  return ok;
}

function buildGrid(){
  const g=document.getElementById('cgrid');g.innerHTML='';
  for(let s=0;s<4;s++)for(let ri=0;ri<13;ri++){
    const r=RANK_IDX[ri],c=r*4+s;
    const isRed=(s===1||s===2);
    const b=document.createElement('div');
    b.className='picker-card'+(isRed?' suit-red':' suit-black');
    b.dataset.c=c;
    b.innerHTML=`<span class="p-rank">${RCHAR[r]}</span><span class="p-suit">${SUIT[s]}</span>`;
    b.addEventListener('click',()=>onCard(c));
    g.appendChild(b);
  }
}

function onCard(c){
  if(running)return;
  const a=assign[c];
  if(a===aT){
    // unassign
    assign[c]=-1;
    setCards(aT,getCards(aT).filter(x=>x!==c));
  }else if(a>=0){
    return; // taken by another target
  }else{
    const cards=getCards(aT);
    if(cards.length>=maxCards(aT))return;
    assign[c]=aT;
    cards.push(c);
  }
  validate();render();
}

function clearTarget(t){
  if(running)return;
  getCards(t).forEach(c=>assign[c]=-1);
  setCards(t,[]);
  validate();render();
}

function randomFill(t){
  const cards=getCards(t);
  const max=maxCards(t);
  if(cards.length>=max)return;
  const avail=[];
  for(let c=0;c<52;c++)if(assign[c]===-1)avail.push(c);
  for(let i=avail.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));const tmp=avail[i];avail[i]=avail[j];avail[j]=tmp;}
  const need=max-cards.length;
  for(let i=0;i<Math.min(need,avail.length);i++){assign[avail[i]]=t;cards.push(avail[i]);}
}

function randomTarget(t){
  if(running)return;
  randomFill(t);
  validate();render();
}

function randomAll(){
  if(running)return;
  for(let p=0;p<nP;p++)randomFill(p);
  randomFill(5);randomFill(6);
  validate();render();
}

function render(){
  const container=document.getElementById('trows');
  container.innerHTML='';

  // determine which targets to show
  const targets=[];
  for(let p=0;p<nP;p++)targets.push(p);
  targets.push(5,6);

  for(const t of targets){
    const row=document.createElement('div');
    row.className='trow'+(t===aT?' active':'');
    row.style.borderLeftColor=t===aT?TCOL[t]:'transparent';

    // clicking the row (not the clear btn) sets active target
    row.addEventListener('click',e=>{
      if(e.target.closest('.xbtn')||e.target.closest('.rndbtn'))return;
      aT=t;render();
    });

    // label
    const lbl=document.createElement('span');
    lbl.className='tl';
    lbl.style.color=TCOL[t];
    lbl.textContent=TNAME[t];
    row.appendChild(lbl);

    // cards area
    const cardsDiv=document.createElement('div');
    cardsDiv.className='card-slots';
    const cards=getCards(t);
    const max=maxCards(t);

    if(t>=5){
      // board: show with flop/turn/river grouping
      for(let i=0;i<5;i++){
        if(i===3||i===4){
          const div=document.createElement('div');
          div.className='board-divider';
          cardsDiv.appendChild(div);
        }
        const slot=document.createElement('div');
        if(i<cards.length){
          const c=cards[i];
          slot.className='card-slot filled'+((c&3)===1||(c&3)===2?' suit-red':' suit-black');
          slot.innerHTML=`<span class="card-rank">${RCHAR[c>>2]}</span><span class="card-suit">${SUIT[c&3]}</span>`;
          slot.addEventListener('click',e=>{e.stopPropagation();if(running)return;assign[c]=-1;setCards(t,getCards(t).filter(x=>x!==c));validate();render();});
        }else{
          slot.className='card-slot';
          slot.innerHTML='<span style="font-size:1.1em;color:var(--text-dim)">+</span>';
        }
        cardsDiv.appendChild(slot);
      }
    }else{
      // player hand
      for(let i=0;i<max;i++){
        const slot=document.createElement('div');
        if(i<cards.length){
          const c=cards[i];
          slot.className='card-slot filled'+((c&3)===1||(c&3)===2?' suit-red':' suit-black');
          slot.innerHTML=`<span class="card-rank">${RCHAR[c>>2]}</span><span class="card-suit">${SUIT[c&3]}</span>`;
          slot.addEventListener('click',e=>{e.stopPropagation();if(running)return;assign[c]=-1;setCards(t,getCards(t).filter(x=>x!==c));validate();render();});
        }else{
          slot.className='card-slot';
          slot.innerHTML='<span style="font-size:1.1em;color:var(--text-dim)">+</span>';
        }
        cardsDiv.appendChild(slot);
      }
    }
    // random + clear buttons inside card-slots
    if(cards.length<max){
      const rb=document.createElement('button');
      rb.className='rndbtn';
      rb.textContent='Rnd';
      rb.addEventListener('click',e=>{e.stopPropagation();randomTarget(t);});
      cardsDiv.appendChild(rb);
    }
    if(cards.length>0){
      const xb=document.createElement('button');
      xb.className='xbtn';
      xb.textContent='\u00d7';
      xb.addEventListener('click',e=>{e.stopPropagation();clearTarget(t);});
      cardsDiv.appendChild(xb);
    }
    row.appendChild(cardsDiv);

    // count
    const cnt=document.createElement('span');
    cnt.className='tcnt';
    cnt.textContent=`${cards.length}/${max}`;
    row.appendChild(cnt);

    container.appendChild(row);
  }

  // card grid highlights
  document.querySelectorAll('.picker-card').forEach(b=>{
    const c=+b.dataset.c,a=assign[c];
    const red=((c&3)===1||(c&3)===2);
    b.className='picker-card'+(red?' suit-red':' suit-black')+(a>=0?' s'+a:'');
  });

  // info line
  const ad=actualDraws();
  const fs=finalHandSize();
  const ts=tableSize();
  const muck=(ts-nP)*nC;
  document.getElementById('hdinfo').textContent=
    `Table: ${ts} dealt | Muck: ${muck} cards | Draws: ${ad} per player | Final hand: ${fs} cards`;
}

document.getElementById('rndAllBtn').addEventListener('click',()=>randomAll());
document.getElementById('clrBtn').addEventListener('click',()=>{
  if(running)return;
  for(let p=0;p<5;p++){pCards[p].forEach(c=>assign[c]=-1);pCards[p]=[];}
  for(let b=0;b<2;b++){bCards[b].forEach(c=>assign[c]=-1);bCards[b]=[];}
  document.getElementById('resultsArea').style.display='none';
  document.getElementById('progressArea').style.display='none';
  document.getElementById('subscribePrompt').style.display='none';
  validate();render();
});

// ===== RUN SIMULATION (via server) =====
document.getElementById('runBtn').addEventListener('click',()=>startSim());

async function startSim(){
  if(running)return;

  // Check auth
  if(!idToken){
    document.getElementById('err').textContent='Sign in with Google to use the calculator.';
    google.accounts.id.prompt();
    return;
  }
  if(!ensureValidToken()){
    document.getElementById('err').textContent='Session expired. Please sign in again.';
    return;
  }

  running=true;
  const btn=document.getElementById('runBtn');
  btn.innerHTML='<span class="spinner"></span>Calculating\u2026';
  btn.disabled=true;
  document.getElementById('progressArea').style.display='block';
  document.getElementById('ptxt').textContent='Running simulation on server\u2026';
  document.getElementById('subscribePrompt').style.display='none';
  document.getElementById('err').textContent='';

  const hands=[];for(let p=0;p<nP;p++)hands.push([...pCards[p]]);
  const ad=actualDraws();

  try{
    const resp=await fetch('/api/solve',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':'Bearer '+idToken
      },
      body:JSON.stringify({
        playerHands:hands,
        numPlayers:nP,
        startingCards:nC,
        totalDraws:ad,
        numTrials:nT,
        knownBoard1:[...bCards[0]],
        knownBoard2:[...bCards[1]]
      })
    });

    if(resp.status===401){
      idToken=null;authUser=null;
      localStorage.removeItem('esg_id_token');localStorage.removeItem('esg_auth_user');
      updateAuthUI();
      document.getElementById('err').textContent='Session expired. Please sign in again.';
      google.accounts.id.prompt();
      return;
    }

    if(resp.status===403){
      isSubscribed=false;
      localStorage.removeItem('esg_subscribed');
      updateAuthUI();
      document.getElementById('subscribePrompt').style.display='block';
      return;
    }

    if(!resp.ok){
      const err=await resp.json().catch(()=>({error:'Server error'}));
      throw new Error(err.error||'Request failed');
    }

    const d=await resp.json();
    isSubscribed=true;
    localStorage.setItem('esg_subscribed','true');
    updateAuthUI();
    document.getElementById('resultsArea').style.display='block';
    document.getElementById('ptxt').textContent=d.trial.toLocaleString()+' trials completed';
    showResults(d);
  }catch(e){
    document.getElementById('err').textContent='Error: '+e.message;
  }finally{
    running=false;
    btn.textContent='Run';
    btn.disabled=false;
    validate();
  }
}

function showResults(d){
  const tbody=document.getElementById('rbody');tbody.innerHTML='';
  for(let p=0;p<d.numPlayers;p++){
    let html=`<td style="color:${TCOL[p]}">${TNAME[p]}</td>`;
    for(let c=0;c<3;c++){
      html+=`<td>${(d.points[p][c]/d.trial*100).toFixed(1)}%</td>`;
    }
    const scoop=(d.scoops[p]/d.trial*100).toFixed(1);
    const eq=(d.potEq[p]/d.trial*100).toFixed(1);
    html+=`<td>${scoop}%</td><td>${eq}%</td>`;
    const tr=document.createElement('tr');tr.innerHTML=html;tbody.appendChild(tr);
  }
}

// ===== INIT =====
// Clear expired token on load
if (idToken && isTokenExpired()) {
  idToken = null;
  localStorage.removeItem('esg_id_token');
}
buildGrid();render();validate();
updateAuthUI();
updateNotice();
checkPaidReturn();
if (idToken && !isSubscribed) checkSubscriptionStatus();
</script>
</body>
</html>
