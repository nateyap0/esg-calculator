<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESG Equity Calculator</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d1117;--panel:#161b22;--border:#30363d;--accent:#1f6feb;--text:#e6edf3;--text-dim:#c9d1d9;--red:#e74c3c;--card-bg:#f0f0f0;--card-border:#999}
body{font-family:-apple-system,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;justify-content:center;padding:20px}
#app{max-width:820px;width:100%}
h1{font-size:1.5rem;margin-bottom:16px;font-weight:700}
.srow{display:flex;gap:16px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.sg{display:flex;align-items:center;gap:6px}
.sg label{font-size:.82rem;color:var(--text-dim);white-space:nowrap}
.bg{display:flex;gap:2px}
.bg button{padding:4px 10px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer;font-size:.82rem;border-radius:4px;font-family:inherit}
.bg button.act{background:var(--accent);border-color:var(--accent);color:#fff}
.bg button:hover:not(.act){background:#21262d}
.hdinfo{font-size:.78rem;color:var(--text-dim);margin-bottom:10px}
.trows{margin-bottom:12px}
.trow{display:flex;align-items:center;gap:10px;margin-bottom:8px;padding:10px 12px;background:var(--panel);border-radius:8px;border-left:3px solid transparent;cursor:pointer;transition:all .12s}
.trow:hover{background:#1c2333}
.trow.active{background:#1c2333}
.tl{font-weight:700;min-width:68px;font-size:.88rem;flex-shrink:0}
.card-slots{display:flex;gap:4px;flex-wrap:wrap;align-items:center;flex:1}
.card-slot{
  width:44px;height:60px;border:2px dashed var(--border);border-radius:6px;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  transition:all .15s;background:transparent;
}
.card-slot.filled{background:var(--card-bg);border:2px solid var(--card-border)}
.card-slot.filled .card-rank{font-size:1.15em;font-weight:700;font-family:'Courier New',monospace;line-height:1}
.card-slot.filled .card-suit{font-size:1.05em;line-height:1}
.card-slot.filled.suit-red{color:var(--red)}
.card-slot.filled.suit-black{color:#1a1a2e}
.board-divider{width:2px;height:40px;background:var(--accent);border-radius:2px;margin:0 3px;align-self:center;opacity:.4}
.tcnt{color:var(--text-dim);font-size:.78rem;white-space:nowrap}
.xbtn{padding:4px 9px;background:none;border:1px solid var(--border);color:var(--text-dim);border-radius:4px;cursor:pointer;font-size:.95rem;font-family:inherit;line-height:1;align-self:center;margin-left:6px}
.xbtn:hover{background:#da363333;border-color:#f85149;color:#f85149}
.picker-grid{display:grid;grid-template-columns:repeat(13,1fr);gap:3px;margin-bottom:14px}
.picker-card{
  aspect-ratio:0.72;border-radius:5px;display:flex;align-items:center;justify-content:center;
  flex-direction:column;cursor:pointer;transition:all .12s;font-family:'Courier New',monospace;
  background:var(--card-bg);border:2px solid transparent;font-size:.88em;line-height:1.15;
}
.picker-card:hover:not(.s0):not(.s1):not(.s2):not(.s3):not(.s4){border-color:var(--accent);transform:scale(1.08);z-index:1}
.picker-card .p-rank{font-weight:700;font-size:1.2em}
.picker-card .p-suit{font-size:1.15em}
.picker-card.suit-red{color:var(--red)}
.picker-card.suit-black{color:#1a1a2e}
.picker-card.s0{border-color:#58a6ff;box-shadow:0 0 6px rgba(88,166,255,.4)}
.picker-card.s1{border-color:#f97583;box-shadow:0 0 6px rgba(249,117,131,.4)}
.picker-card.s2{border-color:#56d364;box-shadow:0 0 6px rgba(86,211,100,.4)}
.picker-card.s3{border-color:#d2a8ff;box-shadow:0 0 6px rgba(210,168,255,.4)}
.picker-card.s4{border-color:#f0883e;box-shadow:0 0 6px rgba(240,136,62,.4)}
.ctrls{display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.rbtn{padding:9px 22px;border:1px solid #2ea043;background:#238636;color:#fff;font-size:.95rem;font-weight:600;border-radius:6px;cursor:pointer;font-family:inherit}
.rbtn:hover{background:#2ea043}.rbtn:disabled{opacity:.4;cursor:not-allowed}
.rbtn.stop{background:#da3633;border-color:#f85149}
.cbtn{padding:9px 16px;border:1px solid var(--border);background:#21262d;color:var(--text);font-size:.88rem;border-radius:6px;cursor:pointer;font-family:inherit}
.cbtn:hover{background:var(--border)}
.prog{flex:1;min-width:160px}
.pbar{height:5px;background:#21262d;border-radius:3px;overflow:hidden;margin-bottom:3px}
.pfill{height:100%;background:var(--accent);transition:width .3s;width:0%}
.ptxt{font-size:.78rem;color:var(--text-dim)}
.err{color:#f97583;font-size:.82rem;margin-bottom:10px;min-height:1.2em}
table{width:100%;border-collapse:collapse;font-size:.95rem}
th{text-align:center;padding:9px 10px;border-bottom:2px solid var(--border);color:var(--text-dim);font-weight:600}
td{text-align:center;padding:9px 10px;border-bottom:1px solid #21262d}
td:first-child{text-align:left;font-weight:700}
tr:last-child td{border-bottom:none}
#resultsArea{display:none}
#progressArea{display:none}
.info{font-size:.78rem;color:#484f58;margin-bottom:14px}
@media(max-width:600px){
  body{padding:6px}
  .card-slot{width:38px;height:52px}
  .picker-grid{gap:2px}
  .picker-card{font-size:.6em}
  .tl{min-width:55px;font-size:.78em}
}
</style>
</head>
<body>
<div id="app">
<h1>ESG Equity Calculator</h1>
<div class="srow">
  <div class="sg"><label>Players</label><div class="bg" id="bPlayers">
    <button data-v="2" class="act">2</button><button data-v="3">3</button>
  </div></div>
  <div class="sg"><label>Starting</label><div class="bg" id="bCards">
    <button data-v="1">1</button><button data-v="2">2</button><button data-v="3">3</button><button data-v="4">4</button><button data-v="5">5</button><button data-v="6" class="act">6</button><button data-v="7">7</button><button data-v="8">8</button>
  </div></div>
  <div class="sg"><label>Trials</label><div class="bg" id="bTrials">
    <button data-v="10000">10K</button><button data-v="50000" class="act">50K</button>
    <button data-v="100000">100K</button><button data-v="250000">250K</button>
  </div></div>
</div>
<div class="srow">
  <div class="sg"><label>Flop</label><div class="bg" id="bFlop">
    <button data-v="1">1</button><button data-v="2">2</button><button data-v="3" class="act">3</button><button data-v="4">4</button>
  </div></div>
  <div class="sg"><label>Turn</label><div class="bg" id="bTurn">
    <button data-v="1">1</button><button data-v="2">2</button><button data-v="3" class="act">3</button><button data-v="4">4</button>
  </div></div>
  <div class="sg"><label>River</label><div class="bg" id="bRiver">
    <button data-v="1">1</button><button data-v="2">2</button><button data-v="3" class="act">3</button><button data-v="4">4</button>
  </div></div>
</div>
<div class="err" id="err"></div>
<div class="trows" id="trows"></div>
<div class="picker-grid" id="cgrid"></div>
<div class="hdinfo" id="hdinfo"></div>
<div class="info">PLO rules: must use exactly 2 from hand + 3 from board. Hand point: best 5-card hand from hole cards only.</div>
<div class="ctrls">
  <button id="runBtn" class="rbtn" disabled>Run</button>
  <button id="clrBtn" class="cbtn">Clear All</button>
  <div class="prog" id="progressArea"><div class="pbar"><div class="pfill" id="pfill"></div></div><div class="ptxt" id="ptxt"></div></div>
</div>
<div id="resultsArea">
  <table><thead><tr><th></th><th>Board 1</th><th>Board 2</th><th>Hand</th><th>Scoop</th><th>Equity</th></tr></thead>
  <tbody id="rbody"></tbody></table>
</div>
</div>
<script>
const RANK_IDX=[12,0,1,2,3,4,5,6,7,8,9,10,11];
const RCHAR='23456789TJQKA';
const SUIT='♠♥♦♣';
const SCLS=[1,0,0,1];
// Colors: P1 blue, P2 red, P3 green, B1 purple, B2 orange
const TCOL=['#58a6ff','#f97583','#56d364','#d2a8ff','#f0883e'];
const TNAME=['Player 1','Player 2','Player 3','Board 1','Board 2'];

let nP=2,nC=6,dF=3,dT=3,dR=3,nT=50000;
let aT=0; // active target: 0-2 players, 3-4 boards
let pCards=[[],[],[]]; // player hands
let bCards=[[],[]]; // board cards (up to 5 each)
let assign=new Int8Array(52).fill(-1); // card -> target (-1=free, 0-2=player, 3-4=board)
let worker=null,running=false;

function cardName(c){return RCHAR[c>>2]+SUIT[c&3]}
function suitCls(c){return SCLS[c&3]?'sb':'sr'}
function cardSpan(c){return `<span class="hc"><span class="${suitCls(c)}">${cardName(c)}</span></span>`}

function initBg(id,cb){
  document.getElementById(id).querySelectorAll('button').forEach(b=>{
    b.addEventListener('click',()=>{
      b.parentElement.querySelectorAll('button').forEach(x=>x.classList.remove('act'));
      b.classList.add('act');
      cb(+b.dataset.v);
    });
  });
}
initBg('bPlayers',v=>{nP=v;onCfg()});
initBg('bCards',v=>{nC=v;onCfg()});
initBg('bFlop',v=>{dF=v;render()});
initBg('bTurn',v=>{dT=v;render()});
initBg('bRiver',v=>{dR=v;render()});
initBg('bTrials',v=>{nT=v});

function tableSize(){return Math.max(nP,Math.min(7,Math.floor(42/nC)))}

function calcDrawSchedule(){
  const muck=(tableSize()-nP)*nC;
  let left=muck;
  const f=Math.min(dF,Math.floor(left/nP));left-=f*nP;
  const t=Math.min(dT,Math.floor(left/nP));left-=t*nP;
  const r=Math.min(dR,Math.floor(left/nP));left-=r*nP;
  return [f,t,r];
}
function finalHandSize(){
  const s=calcDrawSchedule();
  return nC+s[0]+s[1]+s[2];
}

function maxCards(t){return t<3?nC:5}

function getCards(t){return t<3?pCards[t]:bCards[t-3]}

function setCards(t,arr){if(t<3)pCards[t]=arr;else bCards[t-3]=arr;}

function onCfg(){
  // trim player hands if starting cards reduced
  for(let p=0;p<3;p++){
    if(p>=nP){pCards[p].forEach(c=>assign[c]=-1);pCards[p]=[];}
    else while(pCards[p].length>nC){assign[pCards[p].pop()]=-1;}
  }
  if(aT<3&&aT>=nP)aT=0;
  validate();render();
}

function validate(){
  const el=document.getElementById('err');
  el.textContent='';
  let ok=true;
  for(let p=0;p<nP;p++)if(pCards[p].length!==nC)ok=false;
  document.getElementById('runBtn').disabled=!ok||running;
  return ok;
}

function buildGrid(){
  const g=document.getElementById('cgrid');g.innerHTML='';
  for(let s=0;s<4;s++)for(let ri=0;ri<13;ri++){
    const r=RANK_IDX[ri],c=r*4+s;
    const isRed=(s===1||s===2);
    const b=document.createElement('div');
    b.className='picker-card'+(isRed?' suit-red':' suit-black');
    b.dataset.c=c;
    b.innerHTML=`<span class="p-rank">${RCHAR[r]}</span><span class="p-suit">${SUIT[s]}</span>`;
    b.addEventListener('click',()=>onCard(c));
    g.appendChild(b);
  }
}

function onCard(c){
  if(running)return;
  const a=assign[c];
  if(a===aT){
    // unassign
    assign[c]=-1;
    setCards(aT,getCards(aT).filter(x=>x!==c));
  }else if(a>=0){
    return; // taken by another target
  }else{
    const cards=getCards(aT);
    if(cards.length>=maxCards(aT))return;
    assign[c]=aT;
    cards.push(c);
  }
  validate();render();
}

function clearTarget(t){
  if(running)return;
  getCards(t).forEach(c=>assign[c]=-1);
  setCards(t,[]);
  validate();render();
}

function render(){
  const container=document.getElementById('trows');
  container.innerHTML='';

  // determine which targets to show
  const targets=[];
  for(let p=0;p<nP;p++)targets.push(p);
  targets.push(3,4);

  for(const t of targets){
    const row=document.createElement('div');
    row.className='trow'+(t===aT?' active':'');
    row.style.borderLeftColor=t===aT?TCOL[t]:'transparent';

    // clicking the row (not the clear btn) sets active target
    row.addEventListener('click',e=>{
      if(e.target.closest('.xbtn'))return;
      aT=t;render();
    });

    // label
    const lbl=document.createElement('span');
    lbl.className='tl';
    lbl.style.color=TCOL[t];
    lbl.textContent=TNAME[t];
    row.appendChild(lbl);

    // cards area
    const cardsDiv=document.createElement('div');
    cardsDiv.className='card-slots';
    const cards=getCards(t);
    const max=maxCards(t);

    if(t>=3){
      // board: show with flop/turn/river grouping
      for(let i=0;i<5;i++){
        if(i===3||i===4){
          const div=document.createElement('div');
          div.className='board-divider';
          cardsDiv.appendChild(div);
        }
        const slot=document.createElement('div');
        if(i<cards.length){
          const c=cards[i];
          slot.className='card-slot filled'+((c&3)===1||(c&3)===2?' suit-red':' suit-black');
          slot.innerHTML=`<span class="card-rank">${RCHAR[c>>2]}</span><span class="card-suit">${SUIT[c&3]}</span>`;
        }else{
          slot.className='card-slot';
          slot.innerHTML='<span style="font-size:1.1em;color:var(--text-dim)">+</span>';
        }
        cardsDiv.appendChild(slot);
      }
    }else{
      // player hand
      for(let i=0;i<max;i++){
        const slot=document.createElement('div');
        if(i<cards.length){
          const c=cards[i];
          slot.className='card-slot filled'+((c&3)===1||(c&3)===2?' suit-red':' suit-black');
          slot.innerHTML=`<span class="card-rank">${RCHAR[c>>2]}</span><span class="card-suit">${SUIT[c&3]}</span>`;
        }else{
          slot.className='card-slot';
          slot.innerHTML='<span style="font-size:1.1em;color:var(--text-dim)">+</span>';
        }
        cardsDiv.appendChild(slot);
      }
    }
    // clear button inside card-slots, right after last card
    if(cards.length>0){
      const xb=document.createElement('button');
      xb.className='xbtn';
      xb.textContent='×';
      xb.addEventListener('click',e=>{e.stopPropagation();clearTarget(t);});
      cardsDiv.appendChild(xb);
    }
    row.appendChild(cardsDiv);

    // count
    const cnt=document.createElement('span');
    cnt.className='tcnt';
    cnt.textContent=`${cards.length}/${max}`;
    row.appendChild(cnt);

    container.appendChild(row);
  }

  // card grid highlights
  document.querySelectorAll('.picker-card').forEach(b=>{
    const c=+b.dataset.c,a=assign[c];
    const red=((c&3)===1||(c&3)===2);
    b.className='picker-card'+(red?' suit-red':' suit-black')+(a>=0?' s'+a:'');
  });

  // info line
  const sched=calcDrawSchedule();
  const fs=finalHandSize();
  const ts=tableSize();
  const muck=(ts-nP)*nC;
  document.getElementById('hdinfo').textContent=
    `Table: ${ts} dealt | Muck: ${muck} cards | Draws: ${sched[0]}/${sched[1]}/${sched[2]} per player | Final hand: ${fs} cards`;
}

document.getElementById('clrBtn').addEventListener('click',()=>{
  if(running)return;
  for(let p=0;p<3;p++){pCards[p].forEach(c=>assign[c]=-1);pCards[p]=[];}
  for(let b=0;b<2;b++){bCards[b].forEach(c=>assign[c]=-1);bCards[b]=[];}
  document.getElementById('resultsArea').style.display='none';
  document.getElementById('progressArea').style.display='none';
  validate();render();
});

document.getElementById('runBtn').addEventListener('click',()=>{
  if(running)stopSim();else startSim();
});

function startSim(){
  if(worker)worker.terminate();
  running=true;
  const btn=document.getElementById('runBtn');btn.textContent='Stop';btn.classList.add('stop');btn.disabled=false;
  document.getElementById('progressArea').style.display='block';
  document.getElementById('resultsArea').style.display='block';
  document.getElementById('pfill').style.width='0%';

  const hands=[];for(let p=0;p<nP;p++)hands.push([...pCards[p]]);
  const blob=new Blob([WORKER_CODE],{type:'application/javascript'});
  const url=URL.createObjectURL(blob);
  worker=new Worker(url);URL.revokeObjectURL(url);

  const sched=calcDrawSchedule();
  document.getElementById('ptxt').textContent=`0 / ${nT.toLocaleString()} — draws: ${sched[0]}/${sched[1]}/${sched[2]}, final: ${finalHandSize()} cards`;
  worker.postMessage({
    playerHands:hands,numPlayers:nP,startingCards:nC,
    drawFlop:dF,drawTurn:dT,drawRiver:dR,tableSize:tableSize(),numTrials:nT,
    knownBoard1:[...bCards[0]],knownBoard2:[...bCards[1]]
  });
  worker.onmessage=e=>{
    const d=e.data;
    if(d.type==='progress'||d.type==='done'){
      showResults(d);
      const pct=(d.trial/nT*100).toFixed(0);
      document.getElementById('pfill').style.width=pct+'%';
      document.getElementById('ptxt').textContent=d.trial.toLocaleString()+' / '+nT.toLocaleString();
    }
    if(d.type==='done')stopSim();
  };
}

function stopSim(){
  running=false;
  if(worker){worker.terminate();worker=null;}
  const btn=document.getElementById('runBtn');btn.textContent='Run';btn.classList.remove('stop');
  validate();
}

function showResults(d){
  const tbody=document.getElementById('rbody');tbody.innerHTML='';
  for(let p=0;p<d.numPlayers;p++){
    let html=`<td style="color:${TCOL[p]}">${TNAME[p]}</td>`;
    for(let c=0;c<3;c++){
      html+=`<td>${(d.points[p][c]/d.trial*100).toFixed(1)}%</td>`;
    }
    const scoop=(d.scoops[p]/d.trial*100).toFixed(1);
    const eq=(d.potEq[p]/d.trial*100).toFixed(1);
    html+=`<td>${scoop}%</td><td>${eq}%</td>`;
    const tr=document.createElement('tr');tr.innerHTML=html;tbody.appendChild(tr);
  }
}

buildGrid();render();validate();

// ===== WEB WORKER CODE =====
const WORKER_CODE=`'use strict';

// --- PRNG (xorshift128+) ---
let s0=0x12345678,s1=0x9ABCDEF0;
function seed(a,b){s0=a|0||1;s1=b|0||2;}
function rand(){
  let a=s0,b=s1;s0=b;
  a^=a<<23;a^=a>>>17;a^=b;a^=b>>>26;
  s1=a;return(a+b)>>>0;
}
function randInt(n){return rand()%n;}

// --- 5-card evaluator with lookup table ---
const MULT=371294;
const rankTable=new Int32Array(371294);

function buildRankTable(){
  for(let r0=12;r0>=0;r0--)
  for(let r1=r0;r1>=0;r1--)
  for(let r2=r1;r2>=0;r2--)
  for(let r3=r2;r3>=0;r3--)
  for(let r4=r3;r4>=0;r4--){
    const idx=r0*28561+r1*2197+r2*169+r3*13+r4;
    const allUq=r0>r1&&r1>r2&&r2>r3&&r3>r4;
    if(allUq){
      if(r0-r4===4){
        rankTable[idx]=4*MULT+r0;
      }else if(r0===12&&r1===3&&r2===2&&r3===1&&r4===0){
        rankTable[idx]=4*MULT+3;
      }else{
        rankTable[idx]=r0*28561+r1*2197+r2*169+r3*13+r4;
      }
    }else{
      const rr=[r0,r1,r2,r3,r4];
      const gr=[];let i=0;
      while(i<5){let j=i+1;while(j<5&&rr[j]===rr[i])j++;gr.push([rr[i],j-i]);i=j;}
      gr.sort((a,b)=>b[1]-a[1]||b[0]-a[0]);
      const p=gr.map(g=>g[1]).join('');
      if(p==='5'){
        rankTable[idx]=0;
      }else if(p[0]==='4'){
        rankTable[idx]=7*MULT+gr[0][0]*13+gr[1][0];
      }else if(p==='32'){
        rankTable[idx]=6*MULT+gr[0][0]*13+gr[1][0];
      }else if(p==='311'){
        rankTable[idx]=3*MULT+gr[0][0]*169+gr[1][0]*13+gr[2][0];
      }else if(p==='221'){
        rankTable[idx]=2*MULT+gr[0][0]*169+gr[1][0]*13+gr[2][0];
      }else{
        rankTable[idx]=1*MULT+gr[0][0]*2197+gr[1][0]*169+gr[2][0]*13+gr[3][0];
      }
    }
  }
}

function eval5(c0,c1,c2,c3,c4){
  let r0=c0>>2,r1=c1>>2,r2=c2>>2,r3=c3>>2,r4=c4>>2,t;
  if(r0<r3){t=r0;r0=r3;r3=t;}
  if(r1<r4){t=r1;r1=r4;r4=t;}
  if(r0<r2){t=r0;r0=r2;r2=t;}
  if(r1<r3){t=r1;r1=r3;r3=t;}
  if(r0<r1){t=r0;r0=r1;r1=t;}
  if(r2<r4){t=r2;r2=r4;r4=t;}
  if(r1<r2){t=r1;r1=r2;r2=t;}
  if(r3<r4){t=r3;r3=r4;r4=t;}
  if(r2<r3){t=r2;r2=r3;r3=t;}

  let sc=rankTable[r0*28561+r1*2197+r2*169+r3*13+r4];

  if(r0>r1&&r1>r2&&r2>r3&&r3>r4){
    const s=c0&3;
    if(s===(c1&3)&&s===(c2&3)&&s===(c3&3)&&s===(c4&3)){
      if(sc>=4*MULT)sc+=4*MULT;
      else sc+=5*MULT;
    }
  }
  return sc;
}

function best5(hand,n){
  let best=0;
  for(let a=0;a<n-4;a++)
  for(let b=a+1;b<n-3;b++)
  for(let c=b+1;c<n-2;c++)
  for(let d=c+1;d<n-1;d++)
  for(let e=d+1;e<n;e++){
    const s=eval5(hand[a],hand[b],hand[c],hand[d],hand[e]);
    if(s>best)best=s;
  }
  return best;
}

const B3=[[0,1,2],[0,1,3],[0,1,4],[0,2,3],[0,2,4],[0,3,4],[1,2,3],[1,2,4],[1,3,4],[2,3,4]];

function bestPLO(hand,n,board){
  let best=0;
  for(let a=0;a<n-1;a++)
  for(let b=a+1;b<n;b++){
    const h0=hand[a],h1=hand[b];
    for(let i=0;i<10;i++){
      const s=eval5(h0,h1,board[B3[i][0]],board[B3[i][1]],board[B3[i][2]]);
      if(s>best)best=s;
    }
  }
  return best;
}

// --- Monte Carlo simulation ---
buildRankTable();

onmessage=function(e){
  const{playerHands,numPlayers,startingCards,drawFlop,drawTurn,drawRiver,tableSize,numTrials,knownBoard1,knownBoard2}=e.data;

  // draw schedule
  const muckSize=(tableSize-numPlayers)*startingCards;
  let muckLeft=muckSize;
  const reqDraws=[drawFlop,drawTurn,drawRiver];
  const drawSched=[0,0,0];
  for(let st=0;st<3;st++){
    const d=Math.min(reqDraws[st],Math.floor(muckLeft/numPlayers));
    drawSched[st]=d;
    muckLeft-=d*numPlayers;
  }
  const totalDrawsPerPlayer=drawSched[0]+drawSched[1]+drawSched[2];
  const fullSize=startingCards+totalDrawsPerPlayer;

  const kb1=knownBoard1||[];
  const kb2=knownBoard2||[];
  const unknownB1=5-kb1.length;
  const unknownB2=5-kb2.length;

  seed(Date.now()^0xDEAD,(Date.now()>>>4)^0xBEEF);

  // remaining deck (exclude known hands + known boards)
  const known=new Set();
  for(let p=0;p<numPlayers;p++)for(const c of playerHands[p])known.add(c);
  for(const c of kb1)known.add(c);
  for(const c of kb2)known.add(c);
  const remaining=[];
  for(let c=0;c<52;c++)if(!known.has(c))remaining.push(c);
  const R=remaining.length;
  const cardsNeeded=numPlayers*totalDrawsPerPlayer+unknownB1+unknownB2;

  const pts=[];
  const potEq=[];
  const scoops=[];
  for(let p=0;p<numPlayers;p++){pts.push([0,0,0]);potEq.push(0);scoops.push(0);}

  const trialPts=new Float64Array(numPlayers);

  const hands=[];
  for(let p=0;p<numPlayers;p++){
    const h=new Array(fullSize);
    for(let i=0;i<startingCards;i++)h[i]=playerHands[p][i];
    hands.push(h);
  }
  const board1=new Array(5);
  const board2=new Array(5);
  // pre-fill known board cards
  for(let i=0;i<kb1.length;i++)board1[i]=kb1[i];
  for(let i=0;i<kb2.length;i++)board2[i]=kb2[i];

  const BATCH=2500;

  for(let trial=0;trial<numTrials;trial++){
    // partial Fisher-Yates
    for(let i=0;i<cardsNeeded;i++){
      const j=i+randInt(R-i);
      const tmp=remaining[i];remaining[i]=remaining[j];remaining[j]=tmp;
    }

    let idx=0;
    for(let p=0;p<numPlayers;p++)
      for(let d=0;d<totalDrawsPerPlayer;d++)
        hands[p][startingCards+d]=remaining[idx++];

    for(let i=kb1.length;i<5;i++)board1[i]=remaining[idx++];
    for(let i=kb2.length;i<5;i++)board2[i]=remaining[idx++];

    let bestSc0=-1,bestSc1=-1,bestSc2=-1;
    const sc0=new Array(numPlayers);
    const sc1=new Array(numPlayers);
    const sc2=new Array(numPlayers);

    for(let p=0;p<numPlayers;p++){
      const h=hands[p];
      sc0[p]=bestPLO(h,fullSize,board1);
      sc1[p]=bestPLO(h,fullSize,board2);
      sc2[p]=best5(h,fullSize);
      if(sc0[p]>bestSc0)bestSc0=sc0[p];
      if(sc1[p]>bestSc1)bestSc1=sc1[p];
      if(sc2[p]>bestSc2)bestSc2=sc2[p];
    }

    for(let p=0;p<numPlayers;p++)trialPts[p]=0;
    for(let comp=0;comp<3;comp++){
      const best=comp===0?bestSc0:comp===1?bestSc1:bestSc2;
      const sc=comp===0?sc0:comp===1?sc1:sc2;
      let winners=0;
      for(let p=0;p<numPlayers;p++)if(sc[p]===best)winners++;
      const share=1/winners;
      for(let p=0;p<numPlayers;p++)if(sc[p]===best){
        pts[p][comp]+=share;
        trialPts[p]+=share;
      }
    }

    let maxPts=-1;
    for(let p=0;p<numPlayers;p++)if(trialPts[p]>maxPts)maxPts=trialPts[p];
    let potWinners=0;
    for(let p=0;p<numPlayers;p++)if(trialPts[p]===maxPts)potWinners++;
    const potShare=1/potWinners;
    for(let p=0;p<numPlayers;p++)if(trialPts[p]===maxPts){
      potEq[p]+=potShare;
      if(potWinners===1)scoops[p]+=1;
    }

    if((trial+1)%BATCH===0||trial===numTrials-1){
      postMessage({
        type:trial===numTrials-1?'done':'progress',
        trial:trial+1,
        numPlayers,
        points:pts.map(a=>[...a]),
        potEq:[...potEq],
        scoops:[...scoops]
      });
    }
  }
};
`;
</script>
</body>
</html>
