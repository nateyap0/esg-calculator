<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESG Equity Calculator</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#0d1117;color:#c9d1d9;min-height:100vh;display:flex;justify-content:center;padding:20px}
#app{max-width:820px;width:100%}
h1{font-size:1.5rem;margin-bottom:16px;font-weight:700}
.settings{display:flex;gap:20px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.sg{display:flex;align-items:center;gap:6px}
.sg label{font-size:.82rem;color:#8b949e;white-space:nowrap}
.bg{display:flex;gap:3px}
.bg button{padding:5px 13px;border:1px solid #30363d;background:#161b22;color:#c9d1d9;cursor:pointer;font-size:.82rem;border-radius:4px;font-family:inherit}
.bg button.act{background:#1f6feb;border-color:#1f6feb;color:#fff}
.bg button:hover:not(.act){background:#21262d}
.hdinfo{font-size:.78rem;color:#8b949e;margin-bottom:10px}
.ptabs{display:flex;gap:6px;margin-bottom:12px}
.ptab{padding:7px 18px;border:2px solid #30363d;background:#161b22;color:#c9d1d9;cursor:pointer;border-radius:6px;font-size:.88rem;font-weight:600;font-family:inherit;transition:all .15s}
.ptab.a0{border-color:#58a6ff;background:#58a6ff22;color:#58a6ff}
.ptab.a1{border-color:#f97583;background:#f9758322;color:#f97583}
.ptab.a2{border-color:#56d364;background:#56d36422;color:#56d364}
.cgrid{display:grid;grid-template-columns:repeat(13,1fr);gap:3px;margin-bottom:14px}
.cc{padding:7px 2px;border:2px solid #30363d;background:#161b22;cursor:pointer;border-radius:5px;font-size:1.05rem;font-weight:700;text-align:center;line-height:1.2;transition:all .1s;font-family:inherit}
.cc:hover:not(.s0):not(.s1):not(.s2){background:#21262d}
.cc.s0{border-color:#58a6ff;background:#58a6ff30}
.cc.s1{border-color:#f97583;background:#f9758330}
.cc.s2{border-color:#56d364;background:#56d36430}
.sr{color:#f97583}.sb{color:#c9d1d9}
.phands{margin-bottom:16px}
.ph{display:flex;align-items:center;gap:8px;margin-bottom:6px;padding:7px 10px;background:#161b22;border-radius:6px}
.pl{font-weight:700;min-width:68px;font-size:.9rem}
.hcards{display:flex;gap:5px;flex-wrap:wrap}
.hc{padding:3px 7px;background:#21262d;border-radius:4px;font-weight:700;font-size:.95rem}
.ccnt{margin-left:auto;color:#8b949e;font-size:.78rem}
.ctrls{display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.rbtn{padding:9px 22px;border:1px solid #2ea043;background:#238636;color:#fff;font-size:.95rem;font-weight:600;border-radius:6px;cursor:pointer;font-family:inherit}
.rbtn:hover{background:#2ea043}.rbtn:disabled{opacity:.4;cursor:not-allowed}
.rbtn.stop{background:#da3633;border-color:#f85149}
.cbtn{padding:9px 16px;border:1px solid #30363d;background:#21262d;color:#c9d1d9;font-size:.88rem;border-radius:6px;cursor:pointer;font-family:inherit}
.cbtn:hover{background:#30363d}
.prog{flex:1;min-width:160px}
.pbar{height:5px;background:#21262d;border-radius:3px;overflow:hidden;margin-bottom:3px}
.pfill{height:100%;background:#1f6feb;transition:width .3s;width:0%}
.ptxt{font-size:.78rem;color:#8b949e}
.err{color:#f97583;font-size:.82rem;margin-bottom:10px;min-height:1.2em}
table{width:100%;border-collapse:collapse;font-size:.95rem}
th{text-align:center;padding:9px 10px;border-bottom:2px solid #30363d;color:#8b949e;font-weight:600}
td{text-align:center;padding:9px 10px;border-bottom:1px solid #21262d}
td:first-child{text-align:left;font-weight:700}
tr:last-child td{border-bottom:none}
#resultsArea{display:none}
#progressArea{display:none}
.info{font-size:.78rem;color:#484f58;margin-bottom:14px}
</style>
</head>
<body>
<div id="app">
<h1>ESG Equity Calculator</h1>
<div class="settings">
  <div class="sg"><label>Players</label><div class="bg" id="bPlayers">
    <button data-v="2" class="act">2</button><button data-v="3">3</button>
  </div></div>
  <div class="sg"><label>Starting</label><div class="bg" id="bCards">
    <button data-v="5">5</button><button data-v="6" class="act">6</button>
  </div></div>
  <div class="sg"><label>Draws/St</label><div class="bg" id="bDraws">
    <button data-v="1">1</button><button data-v="2" class="act">2</button><button data-v="3">3</button>
  </div></div>
  <div class="sg"><label>Trials</label><div class="bg" id="bTrials">
    <button data-v="10000">10K</button><button data-v="50000" class="act">50K</button>
    <button data-v="100000">100K</button><button data-v="250000">250K</button>
  </div></div>
</div>
<div class="err" id="err"></div>
<div class="ptabs" id="ptabs"></div>
<div class="cgrid" id="cgrid"></div>
<div class="phands" id="phands"></div>
<div class="hdinfo" id="hdinfo"></div>
<div class="info">PLO rules: must use exactly 2 from hand + 3 from board. Hand point: best 5-card hand from hole cards only.</div>
<div class="ctrls">
  <button id="runBtn" class="rbtn" disabled>Run</button>
  <button id="clrBtn" class="cbtn">Clear</button>
  <div class="prog" id="progressArea"><div class="pbar"><div class="pfill" id="pfill"></div></div><div class="ptxt" id="ptxt"></div></div>
</div>
<div id="resultsArea">
  <table><thead><tr><th></th><th>Board 1</th><th>Board 2</th><th>Hand</th><th>Scoop</th><th>Equity</th></tr></thead>
  <tbody id="rbody"></tbody></table>
</div>
</div>
<script>
const RANK_IDX=[12,0,1,2,3,4,5,6,7,8,9,11,10];
const RCHAR='23456789TJQKA';
const SUIT='♠♥♦♣';
const SCLS=[1,0,0,1]; // 0=red,1=black
const PCOL=['#58a6ff','#f97583','#56d364'];
const PNAME=['Player 1','Player 2','Player 3'];
let nP=2,nC=6,nD=2,nT=50000,aP=0;
let pCards=[[],[],[]],assign=new Int8Array(52).fill(-1);
let worker=null,running=false;

function cardName(c){return RCHAR[c>>2]+SUIT[c&3]}
function suitCls(c){return SCLS[c&3]?'sb':'sr'}

function initBg(id,cb){
  document.getElementById(id).querySelectorAll('button').forEach(b=>{
    b.addEventListener('click',()=>{
      b.parentElement.querySelectorAll('button').forEach(x=>x.classList.remove('act'));
      b.classList.add('act');
      cb(+b.dataset.v);
    });
  });
}
initBg('bPlayers',v=>{nP=v;onCfg()});
initBg('bCards',v=>{nC=v;onCfg()});
initBg('bDraws',v=>{nD=v;onCfg()});
initBg('bTrials',v=>{nT=v});

// Calculate actual draws per street (may be reduced on later streets when muck runs out)
function calcDrawSchedule(){
  const muck=(7-nP)*nC;
  let left=muck;
  const perStreet=[];
  for(let st=0;st<3;st++){
    const d=Math.min(nD,Math.floor(left/nP));
    perStreet.push(d);
    left-=d*nP;
  }
  return perStreet;
}
function finalHandSize(){
  const sched=calcDrawSchedule();
  return nC+sched[0]+sched[1]+sched[2];
}

function onCfg(){
  for(let p=0;p<3;p++){
    if(p>=nP){pCards[p].forEach(c=>assign[c]=-1);pCards[p]=[];}
    else while(pCards[p].length>nC){assign[pCards[p].pop()]=-1;}
  }
  if(aP>=nP)aP=0;
  validate();render();
}

function validate(){
  const el=document.getElementById('err');
  el.textContent='';
  let ok=true;
  for(let p=0;p<nP;p++)if(pCards[p].length!==nC)ok=false;
  document.getElementById('runBtn').disabled=!ok||running;
  return ok;
}

function buildGrid(){
  const g=document.getElementById('cgrid');g.innerHTML='';
  for(let s=0;s<4;s++)for(let ri=0;ri<13;ri++){
    const r=RANK_IDX[ri],c=r*4+s;
    const b=document.createElement('button');b.className='cc';b.dataset.c=c;
    b.innerHTML=`<span class="${suitCls(c)}">${RCHAR[r]}${SUIT[s]}</span>`;
    b.addEventListener('click',()=>onCard(c));
    g.appendChild(b);
  }
}

function onCard(c){
  if(running)return;
  const a=assign[c];
  if(a===aP){assign[c]=-1;pCards[aP]=pCards[aP].filter(x=>x!==c);}
  else if(a>=0)return;
  else{if(pCards[aP].length>=nC)return;assign[c]=aP;pCards[aP].push(c);}
  validate();render();
}

function render(){
  // tabs
  const t=document.getElementById('ptabs');t.innerHTML='';
  for(let p=0;p<nP;p++){
    const b=document.createElement('button');
    b.className='ptab'+(p===aP?' a'+p:'');
    b.textContent=PNAME[p]+` (${pCards[p].length}/${nC})`;
    b.addEventListener('click',()=>{aP=p;render()});
    t.appendChild(b);
  }
  // grid highlights
  document.querySelectorAll('.cc').forEach(b=>{
    const c=+b.dataset.c,a=assign[c];
    b.className='cc'+(a>=0?' s'+a:'');
  });
  // hands
  const h=document.getElementById('phands');h.innerHTML='';
  for(let p=0;p<nP;p++){
    const d=document.createElement('div');d.className='ph';
    d.style.borderLeft=`3px solid ${PCOL[p]}`;
    let html=`<span class="pl" style="color:${PCOL[p]}">${PNAME[p]}</span><div class="hcards">`;
    for(const c of pCards[p])html+=`<span class="hc"><span class="${suitCls(c)}">${cardName(c)}</span></span>`;
    html+=`</div><span class="ccnt">${pCards[p].length}/${nC}</span>`;
    d.innerHTML=html;h.appendChild(d);
  }
  // draw schedule info
  const sched=calcDrawSchedule();
  const fs=finalHandSize();
  const muck=(7-nP)*nC;
  document.getElementById('hdinfo').textContent=
    `Muck: ${muck} cards | Draws: ${sched[0]}/${sched[1]}/${sched[2]} per player | Final hand: ${fs} cards`;
}

document.getElementById('clrBtn').addEventListener('click',()=>{
  if(running)return;
  for(let p=0;p<3;p++){pCards[p].forEach(c=>assign[c]=-1);pCards[p]=[];}
  document.getElementById('resultsArea').style.display='none';
  document.getElementById('progressArea').style.display='none';
  validate();render();
});

document.getElementById('runBtn').addEventListener('click',()=>{
  if(running)stopSim();else startSim();
});

function startSim(){
  if(worker)worker.terminate();
  running=true;
  const btn=document.getElementById('runBtn');btn.textContent='Stop';btn.classList.add('stop');btn.disabled=false;
  document.getElementById('progressArea').style.display='block';
  document.getElementById('resultsArea').style.display='block';
  document.getElementById('pfill').style.width='0%';
  document.getElementById('ptxt').textContent='0 / '+nT.toLocaleString();

  const hands=[];for(let p=0;p<nP;p++)hands.push([...pCards[p]]);
  const blob=new Blob([WORKER_CODE],{type:'application/javascript'});
  const url=URL.createObjectURL(blob);
  worker=new Worker(url);URL.revokeObjectURL(url);

  const sched=calcDrawSchedule();
  document.getElementById('ptxt').textContent=`0 / ${nT.toLocaleString()} — draws: ${sched[0]}/${sched[1]}/${sched[2]}, final hand: ${finalHandSize()} cards`;
  worker.postMessage({playerHands:hands,numPlayers:nP,startingCards:nC,drawsPerStreet:nD,numTrials:nT});
  worker.onmessage=e=>{
    const d=e.data;
    if(d.type==='progress'||d.type==='done'){
      showResults(d);
      const pct=(d.trial/nT*100).toFixed(0);
      document.getElementById('pfill').style.width=pct+'%';
      document.getElementById('ptxt').textContent=d.trial.toLocaleString()+' / '+nT.toLocaleString();
    }
    if(d.type==='done')stopSim();
  };
}

function stopSim(){
  running=false;
  if(worker){worker.terminate();worker=null;}
  const btn=document.getElementById('runBtn');btn.textContent='Run';btn.classList.remove('stop');
  validate();
}

function showResults(d){
  const tbody=document.getElementById('rbody');tbody.innerHTML='';
  for(let p=0;p<d.numPlayers;p++){
    let html=`<td style="color:${PCOL[p]}">${PNAME[p]}</td>`;
    for(let c=0;c<3;c++){
      html+=`<td>${(d.points[p][c]/d.trial*100).toFixed(1)}%</td>`;
    }
    const scoop=(d.scoops[p]/d.trial*100).toFixed(1);
    const eq=(d.potEq[p]/d.trial*100).toFixed(1);
    html+=`<td>${scoop}%</td><td>${eq}%</td>`;
    const tr=document.createElement('tr');tr.innerHTML=html;tbody.appendChild(tr);
  }
}

buildGrid();render();validate();

// ===== WEB WORKER CODE =====
const WORKER_CODE=`'use strict';

// --- PRNG (xorshift128+) ---
let s0=0x12345678,s1=0x9ABCDEF0;
function seed(a,b){s0=a|0||1;s1=b|0||2;}
function rand(){
  let a=s0,b=s1;s0=b;
  a^=a<<23;a^=a>>>17;a^=b;a^=b>>>26;
  s1=a;return(a+b)>>>0;
}
function randInt(n){return rand()%n;}

// --- 5-card evaluator with lookup table ---
const MULT=371294;
const rankTable=new Int32Array(371294);

function buildRankTable(){
  for(let r0=12;r0>=0;r0--)
  for(let r1=r0;r1>=0;r1--)
  for(let r2=r1;r2>=0;r2--)
  for(let r3=r2;r3>=0;r3--)
  for(let r4=r3;r4>=0;r4--){
    const idx=r0*28561+r1*2197+r2*169+r3*13+r4;
    const allUq=r0>r1&&r1>r2&&r2>r3&&r3>r4;
    if(allUq){
      if(r0-r4===4){
        rankTable[idx]=4*MULT+r0; // straight
      }else if(r0===12&&r1===3&&r2===2&&r3===1&&r4===0){
        rankTable[idx]=4*MULT+3; // wheel
      }else{
        rankTable[idx]=r0*28561+r1*2197+r2*169+r3*13+r4; // high card
      }
    }else{
      // find groups from sorted desc ranks
      const rr=[r0,r1,r2,r3,r4];
      const gr=[];let i=0;
      while(i<5){let j=i+1;while(j<5&&rr[j]===rr[i])j++;gr.push([rr[i],j-i]);i=j;}
      gr.sort((a,b)=>b[1]-a[1]||b[0]-a[0]);
      const p=gr.map(g=>g[1]).join('');
      if(p==='5'){
        rankTable[idx]=0; // impossible 5-of-a-kind, skip
      }else if(p[0]==='4'){
        rankTable[idx]=7*MULT+gr[0][0]*13+gr[1][0]; // quads
      }else if(p==='32'){
        rankTable[idx]=6*MULT+gr[0][0]*13+gr[1][0]; // full house
      }else if(p==='311'){
        rankTable[idx]=3*MULT+gr[0][0]*169+gr[1][0]*13+gr[2][0]; // trips
      }else if(p==='221'){
        rankTable[idx]=2*MULT+gr[0][0]*169+gr[1][0]*13+gr[2][0]; // two pair
      }else{
        // pair (2111)
        rankTable[idx]=1*MULT+gr[0][0]*2197+gr[1][0]*169+gr[2][0]*13+gr[3][0]; // pair
      }
    }
  }
}

function eval5(c0,c1,c2,c3,c4){
  let r0=c0>>2,r1=c1>>2,r2=c2>>2,r3=c3>>2,r4=c4>>2,t;
  // sort network descending (9 comparators)
  if(r0<r3){t=r0;r0=r3;r3=t;}
  if(r1<r4){t=r1;r1=r4;r4=t;}
  if(r0<r2){t=r0;r0=r2;r2=t;}
  if(r1<r3){t=r1;r1=r3;r3=t;}
  if(r0<r1){t=r0;r0=r1;r1=t;}
  if(r2<r4){t=r2;r2=r4;r4=t;}
  if(r1<r2){t=r1;r1=r2;r2=t;}
  if(r3<r4){t=r3;r3=r4;r4=t;}
  if(r2<r3){t=r2;r2=r3;r3=t;}

  let sc=rankTable[r0*28561+r1*2197+r2*169+r3*13+r4];

  // flush check (only possible when 5 unique ranks)
  if(r0>r1&&r1>r2&&r2>r3&&r3>r4){
    const s=c0&3;
    if(s===(c1&3)&&s===(c2&3)&&s===(c3&3)&&s===(c4&3)){
      if(sc>=4*MULT)sc+=4*MULT; // straight -> straight flush
      else sc+=5*MULT; // high card -> flush
    }
  }
  return sc;
}

// --- best 5 from N cards ---
function best5(hand,n){
  let best=0;
  for(let a=0;a<n-4;a++)
  for(let b=a+1;b<n-3;b++)
  for(let c=b+1;c<n-2;c++)
  for(let d=c+1;d<n-1;d++)
  for(let e=d+1;e<n;e++){
    const s=eval5(hand[a],hand[b],hand[c],hand[d],hand[e]);
    if(s>best)best=s;
  }
  return best;
}

// --- best PLO hand (exactly 2 from hand, 3 from board) ---
// precompute C(5,3) indices
const B3=[[0,1,2],[0,1,3],[0,1,4],[0,2,3],[0,2,4],[0,3,4],[1,2,3],[1,2,4],[1,3,4],[2,3,4]];

function bestPLO(hand,n,board){
  let best=0;
  for(let a=0;a<n-1;a++)
  for(let b=a+1;b<n;b++){
    const h0=hand[a],h1=hand[b];
    for(let i=0;i<10;i++){
      const s=eval5(h0,h1,board[B3[i][0]],board[B3[i][1]],board[B3[i][2]]);
      if(s>best)best=s;
    }
  }
  return best;
}

// --- Monte Carlo simulation ---
buildRankTable();

onmessage=function(e){
  const{playerHands,numPlayers,startingCards,drawsPerStreet,numTrials}=e.data;

  // compute draw schedule: deal as many as possible each street, all players equal
  const muckSize=(7-numPlayers)*startingCards;
  let muckLeft=muckSize;
  const drawSched=[0,0,0]; // draws per player per street
  for(let st=0;st<3;st++){
    const d=Math.min(drawsPerStreet,Math.floor(muckLeft/numPlayers));
    drawSched[st]=d;
    muckLeft-=d*numPlayers;
  }
  const totalDrawsPerPlayer=drawSched[0]+drawSched[1]+drawSched[2];
  const fullSize=startingCards+totalDrawsPerPlayer;

  // seed PRNG
  seed(Date.now()^0xDEAD,(Date.now()>>>4)^0xBEEF);

  // build remaining deck
  const known=new Set();
  for(let p=0;p<numPlayers;p++)for(const c of playerHands[p])known.add(c);
  const remaining=[];
  for(let c=0;c<52;c++)if(!known.has(c))remaining.push(c);
  const R=remaining.length;
  const cardsNeeded=numPlayers*totalDrawsPerPlayer+10;

  // accumulators
  const pts=[];  // component win shares (informational)
  const potEq=[]; // pot equity (scoop-based)
  const scoops=[]; // outright scoop count
  for(let p=0;p<numPlayers;p++){pts.push([0,0,0]);potEq.push(0);scoops.push(0);}

  // pre-allocate per-trial point tallies
  const trialPts=new Float64Array(numPlayers);

  // pre-allocate full hand arrays
  const hands=[];
  for(let p=0;p<numPlayers;p++){
    const h=new Array(fullSize);
    for(let i=0;i<startingCards;i++)h[i]=playerHands[p][i];
    hands.push(h);
  }
  const board1=new Array(5);
  const board2=new Array(5);

  const BATCH=2500;

  for(let trial=0;trial<numTrials;trial++){
    // partial Fisher-Yates shuffle
    for(let i=0;i<cardsNeeded;i++){
      const j=i+randInt(R-i);
      const tmp=remaining[i];remaining[i]=remaining[j];remaining[j]=tmp;
    }

    // assign draws and boards from shuffled cards
    let idx=0;
    for(let p=0;p<numPlayers;p++){
      for(let d=0;d<totalDrawsPerPlayer;d++){
        hands[p][startingCards+d]=remaining[idx++];
      }
    }
    for(let i=0;i<5;i++)board1[i]=remaining[idx++];
    for(let i=0;i<5;i++)board2[i]=remaining[idx++];

    // evaluate each player
    let bestSc0=-1,bestSc1=-1,bestSc2=-1;
    const sc0=new Array(numPlayers);
    const sc1=new Array(numPlayers);
    const sc2=new Array(numPlayers);

    for(let p=0;p<numPlayers;p++){
      const h=hands[p];
      sc0[p]=bestPLO(h,fullSize,board1);
      sc1[p]=bestPLO(h,fullSize,board2);
      sc2[p]=best5(h,fullSize);
      if(sc0[p]>bestSc0)bestSc0=sc0[p];
      if(sc1[p]>bestSc1)bestSc1=sc1[p];
      if(sc2[p]>bestSc2)bestSc2=sc2[p];
    }

    // award component points (split ties)
    for(let p=0;p<numPlayers;p++)trialPts[p]=0;
    for(let comp=0;comp<3;comp++){
      const best=comp===0?bestSc0:comp===1?bestSc1:bestSc2;
      const sc=comp===0?sc0:comp===1?sc1:sc2;
      let winners=0;
      for(let p=0;p<numPlayers;p++)if(sc[p]===best)winners++;
      const share=1/winners;
      for(let p=0;p<numPlayers;p++)if(sc[p]===best){
        pts[p][comp]+=share;
        trialPts[p]+=share;
      }
    }

    // scoop: most points wins the pot, ties split
    let maxPts=-1;
    for(let p=0;p<numPlayers;p++)if(trialPts[p]>maxPts)maxPts=trialPts[p];
    let potWinners=0;
    for(let p=0;p<numPlayers;p++)if(trialPts[p]===maxPts)potWinners++;
    const potShare=1/potWinners;
    for(let p=0;p<numPlayers;p++)if(trialPts[p]===maxPts){
      potEq[p]+=potShare;
      if(potWinners===1)scoops[p]+=1;
    }

    // progress report
    if((trial+1)%BATCH===0||trial===numTrials-1){
      postMessage({
        type:trial===numTrials-1?'done':'progress',
        trial:trial+1,
        numPlayers,
        points:pts.map(a=>[...a]),
        potEq:[...potEq],
        scoops:[...scoops]
      });
    }
  }
};
`;
</script>
</body>
</html>
